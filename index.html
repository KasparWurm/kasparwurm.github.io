<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#feda6a">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arma Reforger Mortar Calculator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1d1e22;
            color: #d4d4dc;
            padding: 20px;
            line-height: 1.6;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .section {
            background: #2a2b2f;
            border-left: 4px solid #feda6a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }

        .calculator {
            grid-column: 1;
        }

        .log-section {
            grid-column: 2;
        }

        .options-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            grid-column: 3;
        }

        h2 {
            color: #feda6a;
            border-bottom: 2px solid #393f4d;
            padding-bottom: 5px;
            font-size: 28px;
        }

        h3 {
            color: #feda6a;
            border-bottom: 2px solid #393f4d;
            padding-bottom: 5px;
            font-size: 28px;
        }

        label {
            display: block;
            margin: 8px 0 4px;
            font-weight: bold;
            color: #feda6a;
        }

        input, select {
            padding: 6px;
            border: 1px solid #393f4d;
            border-radius: 4px;
            width: 30%;
            font-size: 14px;
            margin-bottom: 12px;
            background: #393f4d;
            color: #feda6a;
        }

        button {
            background: #feda6a;
            color: #1d1e22;
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease, color 0.3s ease;
            margin-right: 8px;
            margin-bottom: 10px;
        }

            button:hover {
                background: #ffe793;
            }

        .output {
            background: #393f4d;
            padding: 10px;
            border-left: 5px solid #feda6a;
            margin-top: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            color: #d4d4dc;
        }

        .center-output {
            grid-column: 1;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 10px;
            background: #393f4d;
            border-left: 4px solid #feda6a;
            border-radius: 4px;
        }

        .log-buttons {
            margin-top: 5px;
            display: flex;
            gap: 10px;
        }

            .log-buttons button {
                font-size: 12px;
                padding: 4px 8px;
            }

        @media (max-width: 900px) {
            body {
                grid-template-columns: 1fr;
                padding: 8px;
                gap: 8px;
            }

            .calculator,
            .log-section,
            .options-section,
            .table-view {
                grid-column: 1 !important;
                width: 100%;
                min-width: 0;
            }

            .section {
                margin-bottom: 12px;
                padding: 10px;
            }

            input, select {
                width: 100%;
                font-size: 16px;
            }

            button {
                width: 100%;
                margin-right: 0;
                margin-bottom: 8px;
            }

            .log-buttons {
                flex-direction: column;
                gap: 4px;
            }

            table {
                font-size: 14px;
            }
        }

        #helpOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            max-width: 100vw;
            height: 100vh;
            background: rgba(30,30,30,0.98);
            z-index: 9999;
            overflow: auto;
            padding: 40px;
            box-sizing: border-box;
            border-radius: 0;
        }

        @media (max-width: 900px) {
            #helpOverlay {
                padding: 10px;
                border-radius: 0;
                width: 100vw;
                max-width: 100vw;
            }
        }
    </style>
</head>
<body>
    <button id="helpToggleBtn" style="position:fixed;top:20px;right:20px;z-index:1000;">Help</button>
    <div class="calculator section">
        <h2>Mortar Calculator</h2>
        <label for="mortarPos">Mortar Position (grid format, e.g., 04200240)</label>
        <input type="text" id="mortarPos" placeholder="04200240">
        <label for="mortarElev">Mortar Elevation (meters)</label>
        <input type="number" id="mortarElev" placeholder="40">
        <label for="targetPos">Target Position (grid format, e.g., 04300270)</label>
        <input type="text" id="targetPos" placeholder="04300270">
        <label for="targetElev">
            Target Elevation (meters)
            <span title="Elevation adjustment uses the difference between target and mortar elevation, scaled by a factor from the firing table (dElevPer100mDR).">?</span>
        </label>
        <input type="number" id="targetElev" placeholder="10">
        <label for="ammoType">Ammo Type</label>
        <select id="ammoType">
            <option value="HE">HE</option>
            <option value="Smoke">Smoke</option>
            <option value="Illumination">Illumination</option>
        </select>
        <button onclick="calculateFireData()">Calculate</button>
        <h3>Spotter Correction</h3>
        <label for="correctionDir">Correction Direction</label>
        <select id="correctionDir">
            <option value="L">Left</option>
            <option value="R">Right</option>
            <option value="A">Add</option>
            <option value="D">Drop</option>
        </select>

        <label for="correctionValue">Correction Distance (meters)</label>
        <input type="number" id="correctionValue" placeholder="e.g. 100">

        <button onclick="applySpotterCorrection()">Apply Correction</button>

    </div>

    <div class="section log">
        <h2>Recent Fire Missions</h2>
        <div id="logContainer"></div>
    </div>

    <div class="section" style="grid-column: 3;">
        <h2>Quick Reference</h2>
        <ul>
            <li><strong>Grid Format:</strong> 8 digits (e.g., 04200240)</li>
            <li><strong>Elevation:</strong> Enter in meters</li>
            <li><strong>Ammo Types:</strong> HE, Smoke, Illumination</li>
            <li><strong>Corrections:</strong> Left/Right/Add/Drop</li>
            <li><strong>Help:</strong> Click the Help button for detailed instructions</li>
        </ul>
    </div>

    <div id="helpOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(30,30,30,0.98); z-index:9999; overflow:auto; padding:40px;">
        <button id="closeHelpBtn" style="position:absolute;top:20px;right:80px;z-index:10001;">Close Help</button>

        <div class="options-section">
            <div class="section example">
                <h2>Example Fire Mission</h2>
                <p>
                    <strong>Mortar Grid:</strong> 04200240<br>
                    <strong>Target Grid:</strong> 04300270<br>
                    <strong>Ammo:</strong> HE
                </p>
                <p>
                    <strong>Calculated Range:</strong> ~316 meters<br>
                    <strong>Direction:</strong> 1778 mils (100.00°)<br>
                    <strong>Elevation:</strong> 1534 mils<br>
                    <strong>Charge:</strong> 3
                </p>
                <p>This means you should fire using Charge 3 with elevation set at 1534 mils. Adjust for dispersion after observing the impact.</p>
            </div>
        </div>

        <div class="section table-view" style="grid-column: 3;">
            <h2>Firing Table Viewer</h2>
            <label for="viewerAmmo">Ammo Type</label>
            <select id="viewerAmmo" onchange="updateViewerCharges()">
                <option value="HE">HE</option>
                <option value="SMOKE">SMOKE</option>
                <option value="ILLUMINATION">ILLUMINATION</option>
            </select>

            <label for="viewerCharge">Charge</label>
            <select id="viewerCharge"></select>

            <table id="firingTableViewer" border="1" style="width: 100%; margin-top: 10px;">
                <thead>
                    <tr>
                        <th>Range</th>
                        <th>Elevation (mil)</th>
                        <th>Time of Flight (sec)</th>
                        <th>Elevation Adj/100m (mil)</th>
                        <th>TOF Adj/100m (sec)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="section" style="grid-column: 1;">
            <h3>How are Elevation and Time of Flight Calculated?</h3>
            <!-- Visual Diagram -->
            <div style="text-align:center; margin-bottom: 16px;">
                <svg width="320" height="100" viewBox="0 0 320 100" style="background:#222; border-radius:8px;">
                    <!-- Ground line -->
                    <line x1="20" y1="80" x2="300" y2="80" stroke="#feda6a" stroke-width="2" />
                    <!-- Mortar -->
                    <circle cx="60" cy="60" r="10" fill="#feda6a" />
                    <text x="60" y="55" text-anchor="middle" fill="#feda6a" font-size="12">Mortar</text>
                    <!-- Target (higher elevation) -->
                    <circle cx="260" cy="40" r="10" fill="#d4d4dc" />
                    <text x="260" y="35" text-anchor="middle" fill="#d4d4dc" font-size="12">Target</text>
                    <!-- Elevation arrow -->
                    <line x1="260" y1="80" x2="260" y2="40" stroke="#feda6a" stroke-width="2" marker-end="url(#arrowhead)" />
                    <text x="265" y="60" fill="#feda6a" font-size="12" font-weight="bold">Elevation Difference</text>
                    <!-- Arrowhead definition -->
                    <defs>
                        <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto">
                            <polygon points="0 0, 6 3, 0 6" fill="#feda6a" />
                        </marker>
                    </defs>
                </svg>
            </div>
            <p>
                Accurate mortar fire requires adjusting for elevation differences between the mortar and the target. This calculator uses firing tables to make these adjustments automatically.
            </p>
            <ul>
                <li>
                    <strong>Elevation Adjustment:</strong>
                    <br>
                    The difference in elevation between the target and mortar is multiplied by a table factor (<code>dElevPer100mDR</code>) to fine-tune the firing elevation.
                    <br>
                    <em>Example:</em> If the target is 20m higher than the mortar and the table factor is 15, the adjustment is <code>(20 / 100) × 15 = 3 mils</code>.
                </li>
                <li>
                    <strong>Time of Flight Adjustment:</strong>
                    <br>
                    The calculator also adjusts the time of flight using the elevation difference and a table factor (<code>tofPer100mDR</code>).
                    <br>
                    <em>Example:</em> If the target is 20m higher and the table factor is 0.1, the adjustment is <code>(20 / 100) × 0.1 = 0.02 seconds</code>.
                </li>
                <li>
                    <strong>Table Factors:</strong>
                    <br>
                    <code>dElevPer100mDR</code>: Elevation change per 100m elevation difference.<br>
                    <code>tofPer100mDR</code>: Time of flight change per 100m elevation difference.
                </li>
                <li>
                    If no adjustment factor is available, the base table value is used.
                </li>
            </ul>
            <details>
                <summary>Show full calculation formula</summary>
                <pre>
                    Elevation Adjustment = (Target Elevation - Mortar Elevation) / 100 × dElevPer100mDR
                    Time of Flight Adjustment = (Target Elevation - Mortar Elevation) / 100 × tofPer100mDR
    </pre>
            </details>
        </div>
    </div>

    <footer style="grid-column: 1 / span 3; text-align: center; margin-top: 40px; color: #888;">
        &copy; 2025 Arma Reforger Mortar Calculator | <a href="https://github.com/kasparwurm" style="color:#feda6a;">GitHub</a>
    </footer>

    <script>
        const firingTables = {
            HE: {
                0: [
                    { range: 50, elevation: 1540, tof: 13.2, dElevPer100mDR: 61, tofPer100mDR: null },
                    { range: 100, elevation: 1479, tof: 13.2, dElevPer100mDR: 63, tofPer100mDR: 0.2 },
                    { range: 150, elevation: 1413, tof: 13.0, dElevPer100mDR: 66, tofPer100mDR: 0.2 },
                    { range: 200, elevation: 1350, tof: 12.8, dElevPer100mDR: 71, tofPer100mDR: 0.2 },
                    { range: 250, elevation: 1279, tof: 12.6, dElevPer100mDR: 78, tofPer100mDR: 0.3 },
                    { range: 300, elevation: 1201, tof: 12.3, dElevPer100mDR: 95, tofPer100mDR: 0.6 },
                    { range: 350, elevation: 1106, tof: 11.7, dElevPer100mDR: 151, tofPer100mDR: 1 },
                    { range: 400, elevation: 955, tof: 10.7, dElevPer100mDR: null, tofPer100mDR: null }
                ],
                1: [
                    { range: 100, elevation: 1547, tof: 20.0, dElevPer100mDR: 28, tofPer100mDR: 0.1 },
                    { range: 200, elevation: 1492, tof: 19.9, dElevPer100mDR: 27, tofPer100mDR: 0.1 },
                    { range: 300, elevation: 1437, tof: 19.7, dElevPer100mDR: 29, tofPer100mDR: 0.1 },
                    { range: 400, elevation: 1378, tof: 19.5, dElevPer100mDR: 31, tofPer100mDR: 0.1 },
                    { range: 500, elevation: 1317, tof: 19.2, dElevPer100mDR: 33, tofPer100mDR: 0.2 },
                    { range: 600, elevation: 1249, tof: 18.8, dElevPer100mDR: 35, tofPer100mDR: 0.2 },
                    { range: 700, elevation: 1174, tof: 18.3, dElevPer100mDR: 42, tofPer100mDR: 0.4 },
                    { range: 800, elevation: 1085, tof: 17.5, dElevPer100mDR: 57, tofPer100mDR: 0.6 },
                    { range: 900, elevation: 954, tof: 16.1, dElevPer100mDR: 148, tofPer100mDR: 1.8 }
                ],
                2: [
                    { range: 200, elevation: 1538, tof: 26.6, dElevPer100mDR: 15, tofPer100mDR: null },
                    { range: 300, elevation: 1507, tof: 26.5, dElevPer100mDR: 16, tofPer100mDR: null },
                    { range: 400, elevation: 1475, tof: 26.4, dElevPer100mDR: 16, tofPer100mDR: null },
                    { range: 500, elevation: 1443, tof: 26.3, dElevPer100mDR: 16, tofPer100mDR: 0.1 },
                    { range: 600, elevation: 1410, tof: 26.2, dElevPer100mDR: 16, tofPer100mDR: 0.1 },
                    { range: 700, elevation: 1376, tof: 26.0, dElevPer100mDR: 17, tofPer100mDR: 0.1 },
                    { range: 800, elevation: 1341, tof: 25.8, dElevPer100mDR: 18, tofPer100mDR: 0.1 },
                    { range: 900, elevation: 1305, tof: 25.5, dElevPer100mDR: 20, tofPer100mDR: 0.1 },
                    { range: 1000, elevation: 1266, tof: 25.2, dElevPer100mDR: 20, tofPer100mDR: 0.1 },
                    { range: 1100, elevation: 1225, tof: 24.9, dElevPer100mDR: 22, tofPer100mDR: 0.2 },
                    { range: 1200, elevation: 1180, tof: 24.4, dElevPer100mDR: 23, tofPer100mDR: 0.2 },
                    { range: 1300, elevation: 1132, tof: 23.9, dElevPer100mDR: 27, tofPer100mDR: 0.3 },
                    { range: 1400, elevation: 1076, tof: 23.2, dElevPer100mDR: 31, tofPer100mDR: 0.4 },
                    { range: 1500, elevation: 1009, tof: 22.3, dElevPer100mDR: 43, tofPer100mDR: 0.6 },
                    { range: 1600, elevation: 912, tof: 20.9, dElevPer100mDR: 109, tofPer100mDR: 1.9 }
                ],
                3: [
                    { range: 300, elevation: 1534, tof: 31.7, dElevPer100mDR: 12, tofPer100mDR: null },
                    { range: 400, elevation: 1511, tof: 31.6, dElevPer100mDR: 11, tofPer100mDR: null },
                    { range: 500, elevation: 1489, tof: 31.6, dElevPer100mDR: 12, tofPer100mDR: 0.1 },
                    { range: 600, elevation: 1466, tof: 31.5, dElevPer100mDR: 12, tofPer100mDR: 0.1 },
                    { range: 700, elevation: 1442, tof: 31.4, dElevPer100mDR: 12, tofPer100mDR: 0.1 },
                    { range: 800, elevation: 1419, tof: 31.3, dElevPer100mDR: 12, tofPer100mDR: 0.1 },
                    { range: 900, elevation: 1395, tof: 31.1, dElevPer100mDR: 13, tofPer100mDR: 0.1 },
                    { range: 1000, elevation: 1370, tof: 31.0, dElevPer100mDR: 13, tofPer100mDR: 0.1 },
                    { range: 1100, elevation: 1344, tof: 30.8, dElevPer100mDR: 13, tofPer100mDR: 0.1 },
                    { range: 1200, elevation: 1318, tof: 30.6, dElevPer100mDR: 13, tofPer100mDR: 0.1 },
                    { range: 1300, elevation: 1291, tof: 30.3, dElevPer100mDR: 14, tofPer100mDR: 0.1 },
                    { range: 1400, elevation: 1263, tof: 30.1, dElevPer100mDR: 15, tofPer100mDR: 0.2 },
                    { range: 1500, elevation: 1233, tof: 29.7, dElevPer100mDR: 15, tofPer100mDR: 0.1 },
                    { range: 1600, elevation: 1202, tof: 29.4, dElevPer100mDR: 16, tofPer100mDR: 0.2 },
                    { range: 1700, elevation: 1169, tof: 29.0, dElevPer100mDR: 17, tofPer100mDR: 0.2 },
                    { range: 1800, elevation: 1133, tof: 28.5, dElevPer100mDR: 19, tofPer100mDR: 0.2 },
                    { range: 1900, elevation: 1094, tof: 28.0, dElevPer100mDR: 21, tofPer100mDR: 0.3 },
                    { range: 2000, elevation: 1051, tof: 27.3, dElevPer100mDR: 26, tofPer100mDR: 0.4 },
                    { range: 2100, elevation: 999, tof: 26.5, dElevPer100mDR: 31, tofPer100mDR: 0.5 },
                    { range: 2200, elevation: 931, tof: 25.3, dElevPer100mDR: 46, tofPer100mDR: 0.9 },
                    { range: 2300, elevation: 801, tof: 22.7, dElevPer100mDR: null, tofPer100mDR: null }
                ],
                4: [
                    { range: 400, elevation: 1531, tof: 36.3, dElevPer100mDR: 9, tofPer100mDR: null },
                    { range: 500, elevation: 1514, tof: 36.2, dElevPer100mDR: 9, tofPer100mDR: null },
                    { range: 600, elevation: 1496, tof: 36.2, dElevPer100mDR: 9, tofPer100mDR: 0.1 },
                    { range: 700, elevation: 1478, tof: 36.1, dElevPer100mDR: 9, tofPer100mDR: null },
                    { range: 800, elevation: 1460, tof: 36.0, dElevPer100mDR: 9, tofPer100mDR: null },
                    { range: 900, elevation: 1442, tof: 35.9, dElevPer100mDR: 9, tofPer100mDR: null },
                    { range: 1000, elevation: 1424, tof: 35.8, dElevPer100mDR: 10, tofPer100mDR: null },
                    { range: 1100, elevation: 1405, tof: 35.7, dElevPer100mDR: 10, tofPer100mDR: 0.1 },
                    { range: 1200, elevation: 1385, tof: 35.6, dElevPer100mDR: 9, tofPer100mDR: 0.1 },
                    { range: 1300, elevation: 1366, tof: 35.4, dElevPer100mDR: 10, tofPer100mDR: 0.1 },
                    { range: 1400, elevation: 1346, tof: 35.3, dElevPer100mDR: 10, tofPer100mDR: 0.1 },
                    { range: 1500, elevation: 1326, tof: 35.1, dElevPer100mDR: 11, tofPer100mDR: 0.1 },
                    { range: 1600, elevation: 1305, tof: 34.9, dElevPer100mDR: 11, tofPer100mDR: 0.1 },
                    { range: 1700, elevation: 1283, tof: 34.6, dElevPer100mDR: 11, tofPer100mDR: 0.1 },
                    { range: 1800, elevation: 1261, tof: 34.4, dElevPer100mDR: 11, tofPer100mDR: 0.1 },
                    { range: 1900, elevation: 1238, tof: 34.1, dElevPer100mDR: 12, tofPer100mDR: 0.1 },
                    { range: 2000, elevation: 1214, tof: 33.8, dElevPer100mDR: 12, tofPer100mDR: 0.1 },
                    { range: 2100, elevation: 1188, tof: 33.5, dElevPer100mDR: 13, tofPer100mDR: 0.2 },
                    { range: 2200, elevation: 1162, tof: 33.1, dElevPer100mDR: 14, tofPer100mDR: 0.2 },
                    { range: 2300, elevation: 1134, tof: 32.7, dElevPer100mDR: 15, tofPer100mDR: 0.2 },
                    { range: 2400, elevation: 1104, tof: 32.2, dElevPer100mDR: 17, tofPer100mDR: 0.2 },
                    { range: 2500, elevation: 1070, tof: 31.7, dElevPer100mDR: 17, tofPer100mDR: 0.3 },
                    { range: 2600, elevation: 1034, tof: 31.0, dElevPer100mDR: 20, tofPer100mDR: 0.3 },
                    { range: 2700, elevation: 993, tof: 30.3, dElevPer100mDR: 25, tofPer100mDR: 0.5 },
                    { range: 2800, elevation: 942, tof: 29.2, dElevPer100mDR: 31, tofPer100mDR: 0.6 },
                    { range: 2900, elevation: 870, tof: 27.7, dElevPer100mDR: 64, tofPer100mDR: 1.5 }
                ]
            },
            SMOKE: {
                1: [
                    { range: 200, elevation: 1463, tof: 17.7, dElevPer100mDR: 36, tofPer100mDR: 0.1 },
                    { range: 250, elevation: 1427, tof: 17.6, dElevPer100mDR: 36, tofPer100mDR: 0.1 },
                    { range: 300, elevation: 1391, tof: 17.5, dElevPer100mDR: 39, tofPer100mDR: 0.2 },
                    { range: 350, elevation: 1352, tof: 17.3, dElevPer100mDR: 38, tofPer100mDR: 0.1 },
                    { range: 400, elevation: 1314, tof: 17.2, dElevPer100mDR: 43, tofPer100mDR: 0.3 },
                    { range: 450, elevation: 1271, tof: 16.9, dElevPer100mDR: 44, tofPer100mDR: 0.2 },
                    { range: 500, elevation: 1227, tof: 16.7, dElevPer100mDR: 49, tofPer100mDR: 0.3 },
                    { range: 550, elevation: 1178, tof: 16.4, dElevPer100mDR: 54, tofPer100mDR: 0.4 },
                    { range: 600, elevation: 1124, tof: 16.0, dElevPer100mDR: 64, tofPer100mDR: 0.6 },
                    { range: 650, elevation: 1060, tof: 15.4, dElevPer100mDR: 78, tofPer100mDR: 0.7 },
                    { range: 700, elevation: 982, tof: 14.7, dElevPer100mDR: 160, tofPer100mDR: 1.7 },
                    { range: 750, elevation: 822, tof: 13.0, dElevPer100mDR: null, tofPer100mDR: null }
                ],
                2: [
                    { range: 200, elevation: 1528, tof: 24.8, dElevPer100mDR: 19, tofPer100mDR: 0.1 },
                    { range: 300, elevation: 1491, tof: 24.7, dElevPer100mDR: 19, tofPer100mDR: 0.1 },
                    { range: 400, elevation: 1453, tof: 24.6, dElevPer100mDR: 19, tofPer100mDR: 0.1 },
                    { range: 500, elevation: 1414, tof: 24.4, dElevPer100mDR: 19, tofPer100mDR: 0.1 },
                    { range: 600, elevation: 1374, tof: 24.2, dElevPer100mDR: 20, tofPer100mDR: 0.1 },
                    { range: 700, elevation: 1333, tof: 24.0, dElevPer100mDR: 22, tofPer100mDR: 0.1 },
                    { range: 800, elevation: 1289, tof: 23.7, dElevPer100mDR: 23, tofPer100mDR: 0.2 },
                    { range: 900, elevation: 1242, tof: 23.3, dElevPer100mDR: 25, tofPer100mDR: 0.2 },
                    { range: 1000, elevation: 1191, tof: 22.9, dElevPer100mDR: 28, tofPer100mDR: 0.3 },
                    { range: 1100, elevation: 1133, tof: 22.3, dElevPer100mDR: 31, tofPer100mDR: 0.3 },
                    { range: 1200, elevation: 1067, tof: 21.6, dElevPer100mDR: 39, tofPer100mDR: 0.5 },
                    { range: 1300, elevation: 980, tof: 20.5, dElevPer100mDR: 58, tofPer100mDR: 0.9 },
                    { range: 1400, elevation: 818, tof: 18.0, dElevPer100mDR: null, tofPer100mDR: null }
                ],
                3: [
                    { range: 300, elevation: 1522, tof: 29.6, dElevPer100mDR: 14, tofPer100mDR: null },
                    { range: 400, elevation: 1495, tof: 29.6, dElevPer100mDR: 14, tofPer100mDR: 0.1 },
                    { range: 500, elevation: 1468, tof: 29.5, dElevPer100mDR: 14, tofPer100mDR: 0.1 },
                    { range: 600, elevation: 1440, tof: 29.3, dElevPer100mDR: 14, tofPer100mDR: null },
                    { range: 700, elevation: 1412, tof: 29.2, dElevPer100mDR: 14, tofPer100mDR: 0.1 },
                    { range: 800, elevation: 1383, tof: 29.0, dElevPer100mDR: 14, tofPer100mDR: 0.1 },
                    { range: 900, elevation: 1354, tof: 28.9, dElevPer100mDR: 16, tofPer100mDR: 0.2 },
                    { range: 1000, elevation: 1323, tof: 28.6, dElevPer100mDR: 16, tofPer100mDR: 0.1 },
                    { range: 1100, elevation: 1291, tof: 28.4, dElevPer100mDR: 17, tofPer100mDR: 0.2 },
                    { range: 1200, elevation: 1257, tof: 28.1, dElevPer100mDR: 18, tofPer100mDR: 0.2 },
                    { range: 1300, elevation: 1221, tof: 27.7, dElevPer100mDR: 18, tofPer100mDR: 0.2 },
                    { range: 1400, elevation: 1183, tof: 27.3, dElevPer100mDR: 20, tofPer100mDR: 0.2 },
                    { range: 1500, elevation: 1142, tof: 26.8, dElevPer100mDR: 23, tofPer100mDR: 0.3 },
                    { range: 1600, elevation: 1096, tof: 26.2, dElevPer100mDR: 25, tofPer100mDR: 0.3 },
                    { range: 1700, elevation: 1044, tof: 25.5, dElevPer100mDR: 30, tofPer100mDR: 0.5 },
                    { range: 1800, elevation: 980, tof: 24.5, dElevPer100mDR: 38, tofPer100mDR: 0.6 },
                    { range: 1900, elevation: 892, tof: 23.0, dElevPer100mDR: 84, tofPer100mDR: 1.5 }
                ],
                4: [
                    { range: 400, elevation: 1517, tof: 33.6, dElevPer100mDR: 11, tofPer100mDR: null },
                    { range: 500, elevation: 1495, tof: 33.5, dElevPer100mDR: 10, tofPer100mDR: null },
                    { range: 600, elevation: 1474, tof: 33.5, dElevPer100mDR: 11, tofPer100mDR: 0.1 },
                    { range: 700, elevation: 1452, tof: 33.4, dElevPer100mDR: 11, tofPer100mDR: 0.1 },
                    { range: 800, elevation: 1429, tof: 33.2, dElevPer100mDR: 11, tofPer100mDR: null },
                    { range: 900, elevation: 1407, tof: 33.1, dElevPer100mDR: 12, tofPer100mDR: null },
                    { range: 1000, elevation: 1383, tof: 33.0, dElevPer100mDR: 11, tofPer100mDR: 0.1 },
                    { range: 1100, elevation: 1360, tof: 32.8, dElevPer100mDR: 12, tofPer100mDR: 0.1 },
                    { range: 1200, elevation: 1335, tof: 32.6, dElevPer100mDR: 12, tofPer100mDR: 0.1 },
                    { range: 1300, elevation: 1310, tof: 32.4, dElevPer100mDR: 13, tofPer100mDR: 0.1 },
                    { range: 1400, elevation: 1284, tof: 32.1, dElevPer100mDR: 14, tofPer100mDR: 0.1 },
                    { range: 1500, elevation: 1257, tof: 31.9, dElevPer100mDR: 14, tofPer100mDR: 0.2 },
                    { range: 1600, elevation: 1228, tof: 31.5, dElevPer100mDR: 15, tofPer100mDR: 0.1 },
                    { range: 1700, elevation: 1199, tof: 31.2, dElevPer100mDR: 17, tofPer100mDR: 0.2 },
                    { range: 1800, elevation: 1166, tof: 30.8, dElevPer100mDR: 16, tofPer100mDR: 0.2 },
                    { range: 1900, elevation: 1132, tof: 30.3, dElevPer100mDR: 18, tofPer100mDR: 0.2 },
                    { range: 2000, elevation: 1096, tof: 29.8, dElevPer100mDR: 21, tofPer100mDR: 0.3 },
                    { range: 2100, elevation: 1055, tof: 29.1, dElevPer100mDR: 23, tofPer100mDR: 0.3 },
                    { range: 2200, elevation: 1008, tof: 28.4, dElevPer100mDR: 28, tofPer100mDR: 0.5 },
                    { range: 2300, elevation: 952, tof: 27.4, dElevPer100mDR: 36, tofPer100mDR: 0.7 },
                    { range: 2400, elevation: 871, tof: 25.8, dElevPer100mDR: 67, tofPer100mDR: 1.5 }
                ]
            },
            ILLUMINATION: {
                1: [
                    { range: 200, elevation: 1463, tof: 18.1, dElevPer100mDR: 35, tofPer100mDR: 0.1 },
                    { range: 250, elevation: 1428, tof: 18.0, dElevPer100mDR: 37, tofPer100mDR: 0.1 },
                    { range: 300, elevation: 1391, tof: 17.9, dElevPer100mDR: 39, tofPer100mDR: 0.2 },
                    { range: 350, elevation: 1352, tof: 17.7, dElevPer100mDR: 40, tofPer100mDR: 0.2 },
                    { range: 400, elevation: 1312, tof: 17.5, dElevPer100mDR: 43, tofPer100mDR: 0.2 },
                    { range: 450, elevation: 1269, tof: 17.3, dElevPer100mDR: 45, tofPer100mDR: 0.3 },
                    { range: 500, elevation: 1224, tof: 17.0, dElevPer100mDR: 49, tofPer100mDR: 0.3 },
                    { range: 550, elevation: 1175, tof: 16.7, dElevPer100mDR: 55, tofPer100mDR: 0.4 },
                    { range: 600, elevation: 1120, tof: 16.3, dElevPer100mDR: 65, tofPer100mDR: 0.6 },
                    { range: 650, elevation: 1055, tof: 15.7, dElevPer100mDR: 81, tofPer100mDR: 0.7 },
                    { range: 700, elevation: 974, tof: 15.0, dElevPer100mDR: 151, tofPer100mDR: 1.7 },
                    { range: 750, elevation: 823, tof: 13.3, dElevPer100mDR: null, tofPer100mDR: null }
                ],
                2: [
                    { range: 200, elevation: 1529, tof: 26.2, dElevPer100mDR: 17, tofPer100mDR: 0.1 },
                    { range: 300, elevation: 1493, tof: 26.1, dElevPer100mDR: 18, tofPer100mDR: 0.1 },
                    { range: 400, elevation: 1457, tof: 26.0, dElevPer100mDR: 19, tofPer100mDR: 0.1 },
                    { range: 500, elevation: 1419, tof: 25.8, dElevPer100mDR: 19, tofPer100mDR: 0.1 },
                    { range: 600, elevation: 1379, tof: 25.6, dElevPer100mDR: 20, tofPer100mDR: 0.1 },
                    { range: 700, elevation: 1338, tof: 25.4, dElevPer100mDR: 21, tofPer100mDR: 0.2 },
                    { range: 800, elevation: 1295, tof: 25.1, dElevPer100mDR: 23, tofPer100mDR: 0.2 },
                    { range: 900, elevation: 1249, tof: 24.7, dElevPer100mDR: 25, tofPer100mDR: 0.2 },
                    { range: 1000, elevation: 1199, tof: 24.3, dElevPer100mDR: 27, tofPer100mDR: 0.3 },
                    { range: 1100, elevation: 1144, tof: 23.7, dElevPer100mDR: 30, tofPer100mDR: 0.3 },
                    { range: 1200, elevation: 1081, tof: 23.0, dElevPer100mDR: 35, tofPer100mDR: 0.4 },
                    { range: 1300, elevation: 1005, tof: 22.0, dElevPer100mDR: 47, tofPer100mDR: 0.6 },
                    { range: 1400, elevation: 900, tof: 20.5, dElevPer100mDR: 98, tofPer100mDR: 1.6 }
                ],
                3: [
                    { range: 300, elevation: 1521, tof: 31.1, dElevPer100mDR: 14, tofPer100mDR: null },
                    { range: 400, elevation: 1494, tof: 31.1, dElevPer100mDR: 14, tofPer100mDR: 0.1 },
                    { range: 500, elevation: 1466, tof: 31.0, dElevPer100mDR: 14, tofPer100mDR: 0.1 },
                    { range: 600, elevation: 1438, tof: 30.8, dElevPer100mDR: 14, tofPer100mDR: null },
                    { range: 700, elevation: 1409, tof: 30.7, dElevPer100mDR: 14, tofPer100mDR: 0.1 },
                    { range: 800, elevation: 1380, tof: 30.5, dElevPer100mDR: 16, tofPer100mDR: 0.1 },
                    { range: 900, elevation: 1349, tof: 30.3, dElevPer100mDR: 16, tofPer100mDR: 0.1 },
                    { range: 1000, elevation: 1317, tof: 30.1, dElevPer100mDR: 16, tofPer100mDR: 0.2 },
                    { range: 1100, elevation: 1284, tof: 29.8, dElevPer100mDR: 18, tofPer100mDR: 0.2 },
                    { range: 1200, elevation: 1249, tof: 29.4, dElevPer100mDR: 19, tofPer100mDR: 0.2 },
                    { range: 1300, elevation: 1212, tof: 29.1, dElevPer100mDR: 20, tofPer100mDR: 0.3 },
                    { range: 1400, elevation: 1172, tof: 28.6, dElevPer100mDR: 21, tofPer100mDR: 0.2 },
                    { range: 1500, elevation: 1128, tof: 28.1, dElevPer100mDR: 22, tofPer100mDR: 0.3 },
                    { range: 1600, elevation: 1081, tof: 27.4, dElevPer100mDR: 26, tofPer100mDR: 0.3 },
                    { range: 1700, elevation: 1027, tof: 26.6, dElevPer100mDR: 30, tofPer100mDR: 0.4 },
                    { range: 1800, elevation: 962, tof: 25.6, dElevPer100mDR: 39, tofPer100mDR: 0.7 },
                    { range: 1900, elevation: 875, tof: 24.1, dElevPer100mDR: 67, tofPer100mDR: 1.3 }
                ],
                4: [
                    { range: 400, elevation: 1515, tof: 35.7, dElevPer100mDR: 11, tofPer100mDR: null },
                    { range: 500, elevation: 1493, tof: 35.7, dElevPer100mDR: 11, tofPer100mDR: 0.1 },
                    { range: 600, elevation: 1471, tof: 35.6, dElevPer100mDR: 11, tofPer100mDR: 0.1 },
                    { range: 700, elevation: 1448, tof: 35.5, dElevPer100mDR: 11, tofPer100mDR: 0.1 },
                    { range: 800, elevation: 1426, tof: 35.4, dElevPer100mDR: 12, tofPer100mDR: 0.1 },
                    { range: 900, elevation: 1402, tof: 35.2, dElevPer100mDR: 12, tofPer100mDR: 0.1 },
                    { range: 1000, elevation: 1378, tof: 35.0, dElevPer100mDR: 12, tofPer100mDR: 0.1 },
                    { range: 1100, elevation: 1353, tof: 34.8, dElevPer100mDR: 13, tofPer100mDR: 0.1 },
                    { range: 1200, elevation: 1328, tof: 34.6, dElevPer100mDR: 13, tofPer100mDR: 0.1 },
                    { range: 1300, elevation: 1301, tof: 34.4, dElevPer100mDR: 14, tofPer100mDR: 0.2 },
                    { range: 1400, elevation: 1274, tof: 34.1, dElevPer100mDR: 14, tofPer100mDR: 0.1 },
                    { range: 1500, elevation: 1245, tof: 33.8, dElevPer100mDR: 15, tofPer100mDR: 0.2 },
                    { range: 1600, elevation: 1215, tof: 33.4, dElevPer100mDR: 15, tofPer100mDR: 0.1 },
                    { range: 1700, elevation: 1184, tof: 33.0, dElevPer100mDR: 17, tofPer100mDR: 0.2 },
                    { range: 1800, elevation: 1151, tof: 32.6, dElevPer100mDR: 18, tofPer100mDR: 0.3 },
                    { range: 1900, elevation: 1115, tof: 32.1, dElevPer100mDR: 19, tofPer100mDR: 0.3 },
                    { range: 2000, elevation: 1076, tof: 31.5, dElevPer100mDR: 21, tofPer100mDR: 0.4 },
                    { range: 2100, elevation: 1033, tof: 30.8, dElevPer100mDR: 23, tofPer100mDR: 0.4 },
                    { range: 2200, elevation: 985, tof: 29.9, dElevPer100mDR: 27, tofPer100mDR: 0.5 },
                    { range: 2300, elevation: 928, tof: 28.8, dElevPer100mDR: 33, tofPer100mDR: 0.6 },
                    { range: 2400, elevation: 855, tof: 27.4, dElevPer100mDR: 52, tofPer100mDR: 1.1 }
                ]
            }
        };
        function addLogEntry(data) {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleString();
            entry.innerHTML = `
                                              <strong>[${timestamp}]</strong><br>
                                              ${data.replace(/\n/g, '<br>')}
                                              <div class="log-buttons">
                                                <button onclick="replayMission(this)">Replay</button>
                                                <button onclick="copyToClipboard(this)">Copy</button>
                                                <button onclick="deleteLogEntry(this)">Delete</button>
                                              </div>
                                            `;
            container.prepend(entry);
        }

        function replayMission(btn) {
            const logText = btn.parentElement.previousSibling.textContent;
            const lines = logText.split("\n");

            let mortarGrid, targetGrid, ammoType;

            lines.forEach(line => {
                if (line.includes("Mortar Grid:")) mortarGrid = line.split(": ")[1];
                if (line.includes("Target Grid:")) targetGrid = line.split(": ")[1];
                if (line.includes("Ammo:")) ammoType = line.split(": ")[1];
            });

            if (mortarGrid) document.getElementById('mortarPos').value = mortarGrid;
            if (targetGrid) document.getElementById('targetPos').value = targetGrid;
            if (ammoType) {
                document.getElementById('ammoType').value = ammoType;
            }

            // Automatically recalculate
            calculateFireData();
        }

        function copyToClipboard(btn) {
            const text = btn.parentElement.previousSibling.textContent;
            navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!"));
        }

        function deleteLogEntry(btn) {
            const entry = btn.closest('.log-entry');
            entry.remove();
        }

        function gridToMeters(grid) {
            if (!/^\d{8}$/.test(grid)) return { x: 0, y: 0 }; // fallback or throw error
            const easting = parseInt(grid.slice(0, 4)) * 10;
            const northing = parseInt(grid.slice(4, 8)) * 10;
            return { x: easting, y: northing };
        }

        function calculateDistance(pos1, pos2) {
            const dx = pos2.x - pos1.x;
            const dy = pos2.y - pos1.y;
            return Math.round(Math.sqrt(dx * dx + dy * dy));
        }

        function calculateDirection(pos1, pos2) {
            const dx = pos2.x - pos1.x;
            const dy = pos2.y - pos1.y;
            const angle = Math.atan2(dx, dy);
            let mils = Math.round((angle * 3200) / Math.PI);
            if (mils < 0) mils += 6400;
            return mils;
        }

        function interpolate(table, range) {
            for (let i = 0; i < table.length - 1; i++) {
                const low = table[i];
                const high = table[i + 1];
                if (range >= low.range && range <= high.range) {
                    const ratio = (range - low.range) / (high.range - low.range);
                    return {
                        elevation: Math.round(low.elevation + ratio * (high.elevation - low.elevation)),
                        tof: parseFloat((low.tof + ratio * (high.tof - low.tof)).toFixed(1)),
                        dElevPer100mDR: low.dElevPer100mDR !== null && high.dElevPer100mDR !== null
                            ? low.dElevPer100mDR + ratio * (high.dElevPer100mDR - low.dElevPer100mDR)
                            : null,
                        tofPer100mDR: low.tofPer100mDR !== null && high.tofPer100mDR !== null
                            ? low.tofPer100mDR + ratio * (high.tofPer100mDR - low.tofPer100mDR)
                            : null
                    };
                }
            }
            return null;
        }

        function autoSelectCharge(ammoType, range) {
            // Returns the best charge (string) for the given ammoType and range
            const charges = Object.keys(firingTables[ammoType] || {});
            let bestCharge = null;
            let bestTof = Infinity;

            for (let charge of charges) {
                const table = firingTables[ammoType][charge];
                if (table.length) {
                    const minRange = table[0].range;
                    const maxRange = table[table.length - 1].range;
                    if (range >= minRange && range <= maxRange) {
                        const interp = interpolate(table, range);
                        if (interp && interp.tof < bestTof) {
                            bestTof = interp.tof;
                            bestCharge = charge;
                        }
                    }
                }
            }
            return bestCharge;
        }

        function calculateFireData() {
            console.log("Calculate button clicked");

            const mortarGrid = document.getElementById('mortarPos').value.trim();
            const targetGrid = document.getElementById('targetPos').value.trim();
            const ammoType = document.getElementById('ammoType').value.toUpperCase();
            const mortarPos = gridToMeters(mortarGrid);
            const targetPos = gridToMeters(targetGrid);
            const range = calculateDistance(mortarPos, targetPos);

            const charge = autoSelectCharge(ammoType, range);
            const firingTable = firingTables[ammoType]?.[charge];

            if (!firingTable) {
                alert('Firing table not found for this ammo/charge.');
                return;
            }

            const interp = interpolate(firingTable, range);
            const mortarElev = parseInt(document.getElementById('mortarElev').value);
            const targetElev = parseInt(document.getElementById('targetElev').value);


            if (!interp) {
                alert('Range out of bounds for selected charge.');
                return;
            }

            const elevDiff = mortarElev - targetElev;
            if (typeof interp.dElevPer100mDR === 'number' && !isNaN(interp.dElevPer100mDR)) {
                const verticalAdjustment = Math.round((elevDiff / 100) * interp.dElevPer100mDR);
                interp.elevation += verticalAdjustment;
            }

            if (typeof interp.tofPer100mDR === 'number' && !isNaN(interp.tofPer100mDR)) {
                interp.tof += (elevDiff / 100) * interp.tofPer100mDR;
            }

            const direction = calculateDirection(mortarPos, targetPos);
            const degrees = (direction * 360 / 6400).toFixed(2);
            const bearing = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'][Math.round(direction / 800) % 8];
            const opt2 = document.getElementById('opt2');
            const opt3 = document.getElementById('opt3');
            const opt5 = document.getElementById('opt5');

            let result = `Mortar Grid: ${mortarGrid}
                                            Target Grid: ${targetGrid}
                                            Ammo: ${ammoType}
                                            Charge: ${charge}
                                            Range: ${range} meters
                                            Direction: ${direction} mils`;
            if (opt2 && opt2.checked) result += `(${degrees}°)`;
            if (opt3 && opt3.checked) result += `${bearing}`;
            result += `
                                            Elevation: ${interp.elevation} mils
                                            Time of Flight: ${interp.tof}s`;

            addLogEntry(`[RANGING SHOT]\n${result}`);
        }

        function updateViewerCharges() {
            const ammo = document.getElementById('viewerAmmo').value.toUpperCase();
            const chargeSelect = document.getElementById('viewerCharge');
            chargeSelect.innerHTML = '';

            console.log("Selected ammo:", ammo);
            console.log("Available charges:", Object.keys(firingTables[ammo] || {}));

            const charges = Object.keys(firingTables[ammo] || {});
            if (!charges.length) {
                const option = document.createElement('option');
                option.text = 'No data';
                chargeSelect.add(option);
                return;
            }

            charges.forEach(charge => {
                const option = document.createElement('option');
                option.value = charge;
                option.text = `Charge ${charge}`;
                chargeSelect.appendChild(option);
            });
            updateFiringTableViewer(); // Load the first table immediately
        }

        function getLastLogBaseGrids() {
            // Find the most recent correction or ranging shot in the log
            const logEntries = document.querySelectorAll('#logContainer .log-entry');
            let lastCorrection = null;
            let lastRanging = null;

            for (let entry of logEntries) {
                const text = entry.textContent;
                if (!lastCorrection && text.includes('[CORRECTION]')) {
                    // Try to extract the Adjusted Target Grid and Mortar Grid from the correction
                    const mortarMatch = text.match(/Mortar Grid:\s*([0-9]{8})/);
                    const targetMatch = text.match(/Adjusted Target Grid:\s*([0-9]{8})/);
                    if (mortarMatch && targetMatch) {
                        lastCorrection = {
                            mortarGrid: mortarMatch[1],
                            targetGrid: targetMatch[1]
                        };
                        break; // Most recent correction found
                    }
                }
                if (!lastRanging && text.includes('[RANGING SHOT]')) {
                    // Try to extract Mortar Grid and Target Grid from the ranging shot
                    const mortarMatch = text.match(/Mortar Grid:\s*([0-9]{8})/);
                    const targetMatch = text.match(/Target Grid:\s*([0-9]{8})/);
                    if (mortarMatch && targetMatch) {
                        lastRanging = {
                            mortarGrid: mortarMatch[1],
                            targetGrid: targetMatch[1]
                        };
                    }
                }
            }
            // Prefer last correction, else last ranging shot, else nulls
            return lastCorrection || lastRanging || { mortarGrid: '', targetGrid: '' };
        }

        function applySpotterCorrection() {
            const direction = document.getElementById('correctionDir').value;
            const value = parseInt(document.getElementById('correctionValue').value);

            // Use last correction if available, else last ranging shot, else current input
            const { mortarGrid, targetGrid } = getLastLogBaseGrids();
            const baseMortarGrid = mortarGrid || document.getElementById('mortarPos').value.trim();
            const baseTargetGrid = targetGrid || document.getElementById('targetPos').value.trim();

            const mortarPos = gridToMeters(baseMortarGrid);
            const targetPos = gridToMeters(baseTargetGrid);

            const dx = targetPos.x - mortarPos.x;
            const dy = targetPos.y - mortarPos.y;
            const baseDistance = Math.sqrt(dx * dx + dy * dy);
            const baseAngleRad = Math.atan2(dx, dy);

            if (value > baseDistance) {
                alert("Correction value exceeds distance to target — too large for angle adjustment.");
                return;
            }
            if (isNaN(value)) {
                alert('Enter a valid correction value.');
                return;
            }

            let correctedDistance = baseDistance;
            let correctedAngleRad = baseAngleRad;

            if (direction === 'L' || direction === 'R') {
                const angleRadOffset = Math.atan(value / baseDistance);
                correctedAngleRad = baseAngleRad + (direction === 'L' ? angleRadOffset : -angleRadOffset);
            } else if (direction === 'A') {
                correctedDistance = baseDistance + value;
            } else if (direction === 'D') {
                correctedDistance = baseDistance - value;
            }

            // Calculate new target position for display
            const newDx = Math.cos(correctedAngleRad) * correctedDistance;
            const newDy = Math.sin(correctedAngleRad) * correctedDistance;
            const newX = Math.round(mortarPos.x + newDx);
            const newY = Math.round(mortarPos.y + newDy);

            const newGrid = `${String(Math.floor(newX / 10)).padStart(4, '0')}${String(Math.floor(newY / 10)).padStart(4, '0')}`;

            let correctedMils = Math.round((correctedAngleRad * 3200) / Math.PI);
            if (correctedMils < 0) correctedMils += 6400;

            const ammoType = document.getElementById('ammoType').value.toUpperCase();
            // Auto-select charge for the corrected distance
            const charge = autoSelectCharge(ammoType, Math.round(correctedDistance));
            const firingTable = firingTables[ammoType]?.[charge];
            const interp = interpolate(firingTable, Math.round(correctedDistance));

            const mortarElev = parseInt(document.getElementById('mortarElev').value);
            const targetElev = parseInt(document.getElementById('targetElev').value);

            if (!isNaN(mortarElev) && !isNaN(targetElev) && interp && typeof interp.dElevPer100mDR === 'number' && !isNaN(interp.dElevPer100mDR)) {
                const elevDiff = targetElev - mortarElev;
                const verticalAdjustment = Math.round((elevDiff / 100) * interp.dElevPer100mDR);
                interp.elevation += verticalAdjustment;
            }

            let output = `Mortar Grid: ${baseMortarGrid}\n`;
            output += `Base Target Grid: ${baseTargetGrid}\n`;
            output += `Base Range: ${Math.round(baseDistance)}m, Direction: ${calculateDirection(mortarPos, targetPos)} mils\n`;

            if (direction === 'L' || direction === 'R') {
                output += `Correction: ${direction} ${value}m\n`;
                output += `New Direction: ${correctedMils} mils\n`;
                output += `Charge: ${charge}\n`;
                output += `Adjusted Target Grid: ${newGrid}`;
                if (interp) output += `\nTime of Flight: ${interp.tof}s`;
            } else {
                output += `Correction: ${direction} ${value}m\n`;
                output += `Corrected Range: ${Math.round(correctedDistance)}m\n`;
                if (interp) {
                    output += `New Elevation: ${interp.elevation} mils\n`;
                    output += `Charge: ${charge}\n`;
                    output += `Time of Flight: ${interp.tof}s\n`;
                } else {
                    output += `New range is outside table bounds.\n`;
                }
                output += `Adjusted Target Grid: ${newGrid}`;
            }

            addLogEntry(`[CORRECTION]\n${output}`);
        }

        function updateFiringTableViewer() {
            const ammo = document.getElementById('viewerAmmo').value.toUpperCase();
            const charge = document.getElementById('viewerCharge').value;
            const table = document.getElementById('firingTableViewer').querySelector('tbody');
            table.innerHTML = '';

            const rows = firingTables[ammo]?.[charge];
            if (!rows) return;

            rows.forEach(row => {
                const elevAdj = row.dElevPer100mDR !== null ? row.dElevPer100mDR : '-';
                const tofAdj = row.tofPer100mDR !== null ? row.tofPer100mDR : '-';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${row.range}</td>
                                    <td>${row.elevation}</td>
                                    <td>${row.tof}</td>
                                    <td>${elevAdj}</td>
                                    <td>${tofAdj}</td>`;
                table.appendChild(tr);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateViewerCharges();
            document.getElementById('viewerCharge').addEventListener('change', updateFiringTableViewer);
        });
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function (reg) {
                        console.log('Service worker registered.', reg);
                    });
            });
        }

        document.getElementById('helpToggleBtn').addEventListener('click', function () {
            const overlay = document.getElementById('helpOverlay');
            if (overlay.style.display === 'none' || overlay.style.display === '') {
                overlay.style.display = 'block';
                this.textContent = 'Close Help';
            } else {
                overlay.style.display = 'none';
                this.textContent = 'Help';
            }
        });

        document.getElementById('closeHelpBtn').addEventListener('click', function () {
            document.getElementById('helpOverlay').style.display = 'none';
            document.getElementById('helpToggleBtn').textContent = 'Help';
        });

    </script>
</body>
</html>
